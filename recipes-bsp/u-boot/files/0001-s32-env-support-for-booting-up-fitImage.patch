From 899a3c9eabfb62f475fc26bcfde92d1ed579d11e Mon Sep 17 00:00:00 2001
From: Meng Li <Meng.Li@windriver.com>
Date: Tue, 11 Apr 2023 18:30:54 +0800
Subject: [PATCH] s32: env: support for booting up fitImage

Add environment variable to support for booting up fitImage
by default.

Upstream-Status: Inappropriate [WR Linux specific]

Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 include/configs/s32-cc.h | 21 ++++++++++++++++++++-
 1 file changed, 20 insertions(+), 1 deletion(-)

diff --git a/include/configs/s32-cc.h b/include/configs/s32-cc.h
index 0ff0758a95..2c31faf4d1 100644
--- a/include/configs/s32-cc.h
+++ b/include/configs/s32-cc.h
@@ -40,6 +40,7 @@
 #define S32CC_BOOT_SCR_ADDR		0x82F00000
 #define S32CC_FDT_ADDR			0x83000000
 #define S32CC_RAMDISK_ADDR		0x90000000
+#define S32CC_FIT_ADDR			0xC4000000
 
 /* Disable Ramdisk & FDT relocation*/
 #define S32CC_INITRD_HIGH_ADDR		0xffffffffffffffff
@@ -116,11 +117,15 @@
 		" root=/dev/ram rw earlycon " EXTRA_BOOT_ARGS ";"\
 		"setenv flashsize " __stringify(FSL_QSPI_FLASH_SIZE) ";\0" \
 	"image=Image\0" \
+	"fitimage=fitImage\0" \
+	"fitimage_addr=" __stringify(S32CC_FIT_ADDR) "\0" \
+	"fit_config_header=conf-freescale_\0" \
 	"initrd_high=" __stringify(S32CC_INITRD_HIGH_ADDR) "\0" \
 	"ipaddr=" S32CC_IPADDR "\0"\
 	"loadfdt=fatload mmc ${mmcdev}:${mmcpart} ${fdt_addr} ${fdt_file}; " \
 		 "run fdt_override;\0" \
 	"loadimage=fatload mmc ${mmcdev}:${mmcpart} ${loadaddr} ${image}\0" \
+	"loadfitimage=fatload mmc ${mmcdev}:${mmcpart} ${fitimage_addr} ${fitimage}\0" \
 	"loadtftpfdt=tftp ${fdt_addr} ${fdt_file};\0" \
 	"loadtftpimage=tftp ${loadaddr} ${image};\0" \
 	"mmcargs=setenv bootargs console=${console},${baudrate}" \
@@ -186,7 +191,13 @@
 		"then " \
 			"run mmcboot; " \
 		"else " \
-			"run netboot; " \
+			"if run loadfitimage; "\
+			"then " \
+				"run mmcargs; " \
+				"bootm ${fitimage_addr}#${fit_config_header}${fdt_file}; " \
+			"else " \
+				"run netboot; " \
+			"fi; " \
 		"fi; " \
 	"else " \
 		"run netboot;" \
@@ -251,6 +262,14 @@
 		"if run loadimage; "\
 		"then " \
 			"run mmcboot; " \
+		"else " \
+			"if run loadfitimage; "\
+			"then " \
+				"run mmcargs; " \
+				"bootm ${fitimage_addr}#${fit_config_header}${fdt_file}; " \
+			"else " \
+				"run netboot; " \
+			"fi; " \
 		"fi; " \
 	"fi"
 #    endif
-- 
2.34.1

